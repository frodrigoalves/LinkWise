<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LinkWise Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { background: #0f172a; color: white; font-family: sans-serif; padding: 2rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 2rem; overflow-x: auto; }
    th, td { border: 1px solid #334155; padding: 8px; text-align: left; }
    th { background: #1e293b; }
    .btn { padding: 10px 15px; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 1rem; }
    #statusBox { display:none; background:#1f2937; padding:1rem; border-radius:10px; margin-top:1rem; }
    iframe { width: 100%; height: 400px; border: 1px solid #334155; border-radius: 10px; margin-top: 2rem; }
    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr { display: block; width: 100%; }
      tr { margin-bottom: 15px; border-bottom: 1px solid #334155; }
      th { text-align: left; }
    }
  </style>
</head>
<body>

<h1>📊 Project Lead Metrics</h1>
<canvas id="leadChart" height="100"></canvas>

<button onclick="toggleStatus()" class="btn">📦 Show Project Status</button>
<div id="statusBox">
  <p><strong>Phase 1:</strong> LinkedIn Auto Scrape + Scoring ✅</p>
  <p><strong>Phase 2:</strong> Messaging + Calendly 🔄 50%</p>
  <p><strong>Phase 3:</strong> Telegram/WhatsApp/Wallet Triggers 🕓 Planned</p>
  <p><strong>Phase 4:</strong> DAO Token CRM 🌐 Visionary</p>
</div>

<h2>🗂️ Leads Table</h2>
<button onclick="exportCSV()" class="btn">⬇️ Export CSV</button>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Email</th>
      <th>Angel Score</th>
      <th>ICP Score</th>
      <th>Final Score</th>
      <th>Tags</th>
    </tr>
  </thead>
  <tbody id="leads-table"></tbody>
</table>

<h2>🧪 Live Status Simulation</h2>
<iframe src="https://linkwise.vercel.app"></iframe>

<script>
const supabase = supabase.createClient(
  'https://qpyaxlgkbrweitufwdrq.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFweWF4bGdrYnJ3ZWl0dWZ3ZHJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NTgyMTgsImV4cCI6MjA2MzUzNDIxOH0.g3_2_P2YQgSlFDCMuIXWfSfSMD3btYkOkCqlAYFZ1HI'
);

let cachedLeads = [];

async function renderChart() {
  const { data, error } = await supabase.from('project_leads_stats').select('*').single();
  if (error) return console.error(error);

  const ctx = document.getElementById('leadChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Angel Score', 'ICP Score', 'Final Score', 'Meetings'],
      datasets: [{
        label: 'Average & Count',
        data: [data.avg_angel, data.avg_icp, data.avg_final, data.scheduled_meetings],
        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444']
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

async function loadLeads() {
  const { data, error } = await supabase.from('leads').select('*').order('created_at', { ascending: false });
  if (error) return console.error('Erro ao carregar leads:', error.message);

  cachedLeads = data;
  const tbody = document.getElementById('leads-table');
  tbody.innerHTML = '';

  data.forEach(lead => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${lead.name}</td>
      <td>${lead.email}</td>
      <td>${lead.angelscore}</td>
      <td>${lead.icpscore}</td>
      <td>${lead.finalscore}</td>
      <td>${lead.tags}</td>
    `;
    tbody.appendChild(row);
  });
}

function toggleStatus() {
  const box = document.getElementById('statusBox');
  box.style.display = box.style.display === 'none' ? 'block' : 'none';
}

function exportCSV() {
  if (!cachedLeads.length) return;
  const headers = Object.keys(cachedLeads[0]);
  const csv = [headers.join(',')].concat(cachedLeads.map(row => headers.map(h => JSON.stringify(row[h] ?? '')).join(','))).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'leads_export.csv';
  a.click();
  URL.revokeObjectURL(url);
}

renderChart();
loadLeads();
</script>

</body>
</html>
